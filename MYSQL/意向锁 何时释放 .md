好的，我们来系统讲解 **意向锁（Intention Lock）在 MySQL/InnoDB 中的释放时机**。

---

## 1️⃣ 意向锁回顾

* **意向锁**是一种表级信号锁，用于表明事务 **打算在表中的某些行加行锁（S/X）**。
* 类型：

  * **IS（Intention Shared）** → 打算加共享行锁
  * **IX（Intention Exclusive）** → 打算加排他行锁
* **作用**：协调表锁和行锁，判断兼容性

> 意向锁不会阻塞事务本身加行锁，只是表级的提示锁。

---

## 2️⃣ 意向锁释放时机

意向锁 **生命周期与事务绑定**：

1. **事务提交或回滚时**：

   * 意向锁会随着事务结束自动释放
   * 释放后，其他事务可以获取冲突表锁
2. **表锁释放时**：

   * 如果事务已经结束或显式解锁，意向锁也随之消失
3. **不能手动释放**：

   * 用户无法单独释放意向锁，它是事务自动管理的

---

## 3️⃣ 举例说明

```sql
-- 事务 A
START TRANSACTION;
SELECT * FROM t WHERE id=1 FOR UPDATE;  -- 对 id=1 加 X 行锁，同时表上加 IX 意向锁

-- 事务 B
LOCK TABLES t WRITE;  -- 尝试加 WRITE 表锁
-- 阻塞，等待事务 A 结束

COMMIT;  -- 事务 A 提交 → 行锁释放，意向锁自动释放

-- 事务 B 继续执行，获得 WRITE 表锁
```

* **关键点**：意向锁 **不会早于事务结束释放**
* 释放顺序：

  1. 事务对行的 X/S 行锁释放
  2. 意向锁随事务释放
  3. 被阻塞的表锁/行锁事务被唤醒

---

## 4️⃣ 总结

| 属性   | 描述            |
| ---- | ------------- |
| 生命周期 | 事务级别          |
| 释放时机 | 事务提交或回滚时自动释放  |
| 手动控制 | 不可单独释放，依赖事务结束 |
| 作用   | 协调行锁和表锁，判断兼容性 |

> 核心理解：意向锁是 **事务的标记锁**，跟随事务自动管理，不会独立存在，也不会手动释放。

---

如果你愿意，我可以画一张 **事务加行锁 → 加意向锁 → 释放示意图**，直观展示意向锁的生命周期和释放时机。

你希望我画吗？
