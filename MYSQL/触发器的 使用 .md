明白了 😄，我们来系统讲解 **MySQL 的触发器（Trigger）** —— 什么是触发器、什么时候使用，以及具体的用法。

---

# 🧩 一、触发器是什么？

* **触发器（Trigger）** 是数据库表级的自动执行机制
* **定义在表上**，当表发生 **INSERT / UPDATE / DELETE** 操作时自动触发
* 可以用来 **保证数据完整性、自动记录日志、同步表数据**

简单理解：

> “当表里发生某些操作时，数据库自己帮你执行某些动作，无需客户端调用。”

---

# 🧠 二、触发器的类型

| 分类        | 说明                             |
| --------- | ------------------------------ |
| **按操作类型** | `INSERT` / `UPDATE` / `DELETE` |
| **按触发时机** | `BEFORE`（操作前触发）、`AFTER`（操作后触发） |

组合起来，总共有 **6 种触发器类型**：

1. BEFORE INSERT
2. AFTER INSERT
3. BEFORE UPDATE
4. AFTER UPDATE
5. BEFORE DELETE
6. AFTER DELETE

---

# ⚙️ 三、触发器的语法

```sql
CREATE TRIGGER trigger_name
{BEFORE | AFTER} {INSERT | UPDATE | DELETE}
ON table_name
FOR EACH ROW
BEGIN
    -- SQL 逻辑
END;
```

* **`FOR EACH ROW`**：表示对每一行触发
* 可以访问特殊变量：

  * `NEW.column` → INSERT / UPDATE 新值
  * `OLD.column` → UPDATE / DELETE 旧值

---

# 🌟 四、触发器示例

### 1️⃣ 自动记录用户注册日志（AFTER INSERT）

```sql
CREATE TRIGGER log_user_insert
AFTER INSERT ON user
FOR EACH ROW
BEGIN
    INSERT INTO user_log(user_id, action, action_time)
    VALUES (NEW.id, '注册', NOW());
END;
```

* 每当 `user` 表新增一条记录时，自动在 `user_log` 写入一条日志

---

### 2️⃣ 自动更新更新时间（BEFORE UPDATE）

```sql
CREATE TRIGGER update_time
BEFORE UPDATE ON user
FOR EACH ROW
BEGIN
    SET NEW.last_modified = NOW();
END;
```

* 每次更新 `user` 表，`last_modified` 自动更新为当前时间

---

### 3️⃣ 防止删除重要数据（BEFORE DELETE）

```sql
CREATE TRIGGER protect_admin
BEFORE DELETE ON user
FOR EACH ROW
BEGIN
    IF OLD.role = 'admin' THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '不能删除管理员用户';
    END IF;
END;
```

* 删除操作前触发，如果角色是管理员则报错阻止删除

---

# 🔁 五、触发器使用注意事项

1. **触发器只能定义一次**，如果需要修改，要先 `DROP TRIGGER` 再创建
2. **触发器不可递归调用**（MySQL 默认禁止触发器调用触发器）
3. **性能考虑**：复杂触发器可能影响 `INSERT/UPDATE/DELETE` 性能
4. **事务配合**：

   * BEFORE 触发器中报错会阻止当前操作
   * AFTER 触发器中报错可以回滚整个事务
5. **访问 OLD / NEW**：

   * INSERT → 可以访问 NEW，不可以访问 OLD
   * DELETE → 可以访问 OLD，不可以访问 NEW
   * UPDATE → 两者都可以访问

---

# 📦 六、查看与删除触发器

* 查看触发器：

```sql
SHOW TRIGGERS;
```

* 删除触发器：

```sql
DROP TRIGGER IF EXISTS trigger_name;
```

---

# 💡 七、触发器使用场景总结

| 场景      | 示例               |
| ------- | ---------------- |
| 自动生成日志  | 用户表插入/更新自动记录操作日志 |
| 自动更新字段  | 更新时间戳、计数器        |
| 数据完整性约束 | 阻止删除关键数据、限制字段值   |
| 表间同步    | 更新订单表时自动更新库存表    |
| 复杂计算    | 插入数据时自动计算衍生字段    |

---

如果你愿意，我可以帮你画一张 **触发器执行流程图**：
`操作（INSERT/UPDATE/DELETE）→ BEFORE触发器 → 主操作 → AFTER触发器 → 完成`，
直观显示触发器触发顺序和 OLD/NEW 变量的使用。

你希望我画吗？
